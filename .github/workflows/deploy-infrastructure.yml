name: Deploy Azure Infrastructure (IaC)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (prod, dev, staging)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - staging
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
      - '.github/workflows/deploy-infrastructure.yml'

env:
  AZURE_LOCATION: 'westeurope'
  AZURE_RESOURCE_GROUP: 'rg-minitrello-prod'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'prod' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Create Resource Group if not exists
        run: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.AZURE_LOCATION }} || true

      - name: Register Required Resource Providers
        run: |
          echo "Registering Microsoft.OperationalInsights provider (required for Application Insights)..."
          az provider register --namespace Microsoft.OperationalInsights --wait || true
          echo "Registering Microsoft.Insights provider..."
          az provider register --namespace Microsoft.Insights --wait || true
          echo "Registration complete."

      - name: Cancel any active deployments
        run: |
          # Cancel any active deployments in the resource group
          DEPLOYMENTS=$(az deployment group list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[?properties.provisioningState=='Running' || properties.provisioningState=='Accepted'].name" -o tsv)
          if [ ! -z "$DEPLOYMENTS" ]; then
            echo "Found active deployments, canceling them..."
            for DEPLOYMENT_NAME in $DEPLOYMENTS; do
              echo "Canceling deployment: $DEPLOYMENT_NAME"
              az deployment group cancel --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name "$DEPLOYMENT_NAME" || true
            done
            echo "Waiting 10 seconds for cancellations to complete..."
            sleep 10
          else
            echo "No active deployments found."
          fi

      - name: Create Parameters File
        run: |
          cat > /tmp/parameters.json <<EOF
          {
            "\$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
            "contentVersion": "1.0.0.0",
            "parameters": {
              "environment": {
                "value": "${{ github.event.inputs.environment || 'prod' }}"
              },
              "location": {
                "value": "${{ env.AZURE_LOCATION }}"
              },
              "postgresAdminLogin": {
                "value": "minitrello_admin"
              },
              "postgresAdminPassword": {
                "value": "${{ secrets.POSTGRES_ADMIN_PASSWORD }}"
              },
              "jwtKey": {
                "value": "${{ secrets.JWT_KEY }}"
              },
              "jwtIssuer": {
                "value": "MiniTrello-API"
              },
              "frontendUrl": {
                "value": "${{ secrets.FRONTEND_URL }}"
              },
              "applicationBaseUrl": {
                "value": "${{ secrets.APPLICATION_BASE_URL }}"
              },
              "resendApiKey": {
                "value": "${{ secrets.RESEND_API_KEY }}"
              },
              "resendFromEmail": {
                "value": "${{ secrets.RESEND_FROM_EMAIL }}"
              },
              "emailSmtpHost": {
                "value": "${{ secrets.EMAIL_SMTP_HOST }}"
              },
              "emailSmtpPort": {
                "value": ${{ secrets.EMAIL_SMTP_PORT || '587' }}
              },
              "emailUsername": {
                "value": "${{ secrets.EMAIL_USERNAME }}"
              },
              "emailPassword": {
                "value": "${{ secrets.EMAIL_PASSWORD }}"
              },
              "emailFromEmail": {
                "value": "${{ secrets.EMAIL_FROM_EMAIL }}"
              },
              "repositoryUrl": {
                "value": "https://github.com/${{ github.repository }}"
              },
              "repositoryBranch": {
                "value": "${{ github.ref_name }}"
              },
              "appServicePrincipalId": {
                "value": "${{ secrets.APP_SERVICE_PRINCIPAL_ID || '' }}"
              }
            }
          }
          EOF

      - name: Deploy Bicep Infrastructure
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ./infrastructure/bicep/main.bicep
          parameters: /tmp/parameters.json
          deploymentName: minitrello-deployment-${{ github.run_id }}-${{ github.run_number }}
          failOnStdErr: false

      - name: Get Deployment Outputs
        id: outputs
        run: |
          DEPLOYMENT_NAME="minitrello-deployment-${{ github.run_id }}-${{ github.run_number }}"
          echo "Infrastructure deployed successfully!"
          echo "Getting outputs from deployment: $DEPLOYMENT_NAME"
          
          BACKEND_URL=$(az deployment group show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name "$DEPLOYMENT_NAME" --query properties.outputs.backendUrl.value -o tsv)
          FRONTEND_URL=$(az deployment group show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name "$DEPLOYMENT_NAME" --query properties.outputs.frontendUrl.value -o tsv)
          STATIC_WEB_APP_NAME=$(az deployment group show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name "$DEPLOYMENT_NAME" --query properties.outputs.staticWebAppName.value -o tsv)
          
          echo "Backend URL: $BACKEND_URL"
          echo "Frontend URL: $FRONTEND_URL"
          echo "Static Web App Name: $STATIC_WEB_APP_NAME"
          echo "::notice title=Deployment URLs::Backend: $BACKEND_URL | Frontend: $FRONTEND_URL"
          
          # Static Web App API Token
          # Note: Token needs to be retrieved manually from Azure Portal after first deployment
          # Go to: Azure Portal > Static Web App ($STATIC_WEB_APP_NAME) > Manage deployment token
          echo "::notice title=Static Web App Token::Token must be retrieved manually from Azure Portal for: $STATIC_WEB_APP_NAME"
          
          echo ""
          echo "=== Next Steps ==="
          echo "1. Update GitHub Secrets with the following URLs:"
          echo "   FRONTEND_URL: $FRONTEND_URL"
          echo "   APPLICATION_BASE_URL: $FRONTEND_URL"
          echo "   VITE_API_BASE_URL: $BACKEND_URL"
          echo ""
          echo "2. Get Static Web App API Token from Azure Portal:"
          echo "   - Go to: Azure Portal > Static Web App ($STATIC_WEB_APP_NAME)"
          echo "   - Navigate to: 'Manage deployment token'"
          echo "   - Copy the token and update AZURE_STATIC_WEB_APPS_API_TOKEN secret"
          echo ""

