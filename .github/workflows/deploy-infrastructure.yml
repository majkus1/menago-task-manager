name: Deploy Azure Infrastructure (IaC)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (prod, dev, staging)'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - dev
          - staging
  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
      - '.github/workflows/deploy-infrastructure.yml'

env:
  AZURE_LOCATION: 'westeurope'
  AZURE_RESOURCE_GROUP: 'rg-minitrello-prod'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'prod' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Create Resource Group if not exists
        run: |
          az group create --name ${{ env.AZURE_RESOURCE_GROUP }} --location ${{ env.AZURE_LOCATION }} || true

      - name: Deploy Bicep Infrastructure
        uses: azure/arm-deploy@v2
        with:
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          template: ./infrastructure/bicep/main.bicep
          parameters: |
            {
              "environment": {
                "value": "${{ github.event.inputs.environment || 'prod' }}"
              },
              "location": {
                "value": "${{ env.AZURE_LOCATION }}"
              },
              "postgresAdminLogin": {
                "value": "minitrello_admin"
              },
              "postgresAdminPassword": {
                "value": "${{ secrets.POSTGRES_ADMIN_PASSWORD }}"
              },
              "jwtKey": {
                "value": "${{ secrets.JWT_KEY }}"
              },
              "jwtIssuer": {
                "value": "MiniTrello-API"
              },
              "frontendUrl": {
                "value": "${{ secrets.FRONTEND_URL }}"
              },
              "applicationBaseUrl": {
                "value": "${{ secrets.APPLICATION_BASE_URL }}"
              },
              "resendApiKey": {
                "value": "${{ secrets.RESEND_API_KEY }}"
              },
              "resendFromEmail": {
                "value": "${{ secrets.RESEND_FROM_EMAIL }}"
              },
              "emailSmtpHost": {
                "value": "${{ secrets.EMAIL_SMTP_HOST }}"
              },
              "emailSmtpPort": {
                "value": ${{ secrets.EMAIL_SMTP_PORT || '587' }}
              },
              "emailUsername": {
                "value": "${{ secrets.EMAIL_USERNAME }}"
              },
              "emailPassword": {
                "value": "${{ secrets.EMAIL_PASSWORD }}"
              },
              "emailFromEmail": {
                "value": "${{ secrets.EMAIL_FROM_EMAIL }}"
              },
              "repositoryUrl": {
                "value": "https://github.com/${{ github.repository }}"
              },
              "repositoryBranch": {
                "value": "${{ github.ref_name }}"
              },
              "appServicePrincipalId": {
                "value": "${{ secrets.APP_SERVICE_PRINCIPAL_ID || '' }}"
              }
            }
          failOnStdErr: false

      - name: Get Deployment Outputs
        id: outputs
        run: |
          echo "Infrastructure deployed successfully!"
          echo "Backend URL: $(az deployment group show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name main --query properties.outputs.backendUrl.value -o tsv)"
          echo "Frontend URL: $(az deployment group show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name main --query properties.outputs.frontendUrl.value -o tsv)"

