name: Deploy Backend to Azure App Service

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  AZURE_LOCATION: 'westeurope'
  AZURE_RESOURCE_GROUP: 'rg-minitrello-prod'
  DOTNET_VERSION: '9.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ./backend/MiniTrello.API.csproj

      - name: Build
        run: dotnet build ./backend/MiniTrello.API.csproj --configuration Release --no-restore

      - name: Test
        run: dotnet test ./backend/MiniTrello.API.csproj --no-build --verbosity normal || true

      - name: Publish
        run: dotnet publish ./backend/MiniTrello.API.csproj --configuration Release --output ./backend/publish --no-build

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Get App Service Name
        id: appServiceName
        run: |
          # Try to find App Service with pattern prod-minitrello-backend or minitrello-backend
          APP_SERVICE_NAME=$(az webapp list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[?contains(name, 'minitrello-backend')].name" -o tsv | head -n 1)
          if [ -z "$APP_SERVICE_NAME" ]; then
            echo "App Service not found. Checking available resources..."
            echo "Available web apps:"
            az webapp list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[].name" -o table || true
            echo "Available resources in resource group:"
            az resource list --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query "[].{Name:name, Type:type}" -o table || true
            echo "Please deploy infrastructure first using 'Deploy Azure Infrastructure (IaC)' workflow."
            exit 1
          fi
          echo "Found App Service: $APP_SERVICE_NAME"
          echo "name=$APP_SERVICE_NAME" >> $GITHUB_OUTPUT

      - name: Deploy to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ steps.appServiceName.outputs.name }}
          package: ./backend/publish

      - name: Wait for App Service to Start
        run: |
          APP_SERVICE_NAME=${{ steps.appServiceName.outputs.name }}
          APP_SERVICE_URL=$(az webapp show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name $APP_SERVICE_NAME --query defaultHostName -o tsv)
          echo "Backend deployed to: https://$APP_SERVICE_URL"
          echo "Waiting 45 seconds for application to start and run migrations..."
          sleep 45

      - name: Health Check
        run: |
          APP_SERVICE_NAME=${{ steps.appServiceName.outputs.name }}
          APP_SERVICE_URL=$(az webapp show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name $APP_SERVICE_NAME --query defaultHostName -o tsv)
          echo "Checking application health..."
          
          # Try to access swagger endpoint (with timeout)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://$APP_SERVICE_URL/swagger/index.html || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "401" ]; then
            echo "✅ Application is responding (HTTP $HTTP_CODE)"
            echo "Swagger UI: https://$APP_SERVICE_URL/swagger"
          else
            echo "⚠️ Application returned HTTP $HTTP_CODE (might still be starting or needs authentication)"
            echo ""
            echo "Checking application status..."
            APP_STATUS=$(az webapp show --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name $APP_SERVICE_NAME --query state -o tsv || echo "unknown")
            echo "App Service State: $APP_STATUS"
          fi
          
          echo ""
          echo "View logs in Azure Portal:"
          echo "https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ env.AZURE_RESOURCE_GROUP }}/providers/Microsoft.Web/sites/$APP_SERVICE_NAME/logStream"

